<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>航班資料轉換工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 行動優先樣式 */
        body {
            font-family: Arial, sans-serif;
            margin: 15px;
            padding: 0;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #333;
            font-size: 1.4em;
            margin-bottom: 20px;
        }

        .upload-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        #file-input {
            display: none;
        }

        .custom-upload {
            display: block;
            padding: 15px;
            background: #007bff;
            color: white;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .custom-upload:hover {
            background: #0056b3;
        }

        #status {
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
        }

        #download-btn {
            display: none;
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (min-width: 768px) {
            h1 { font-size: 1.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>航班資料轉換工具</h1>
        
        <div class="upload-section">
            <input type="file" id="file-input" accept=".xlsx, .xls">
            <label for="file-input" class="custom-upload">選擇 Excel 檔案</label>
            <div id="status">尚未選擇檔案</div>
            <button id="download-btn">下載轉換結果</button>
        </div>

        <div class="loading">
            <div class="spinner"></div>
        </div>
    </div>

    <script>
        let convertedData = [];

        document.getElementById('file-input').addEventListener('change', handleFile);
        document.getElementById('download-btn').addEventListener('click', downloadData);

        function handleFile(e) {
            showLoading(true);
            const file = e.target.files[0];
            
            if (!file) {
                showLoading(false);
                return;
            }

            document.getElementById('status').textContent = '處理中...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    convertedData = convertExcel(workbook);
                    document.getElementById('status').textContent = `${file.name} (${convertedData.length} 筆資料已轉換)`;
                    document.getElementById('download-btn').style.display = 'block';
                } catch (error) {
                    alert('檔案處理錯誤: ' + error.message);
                } finally {
                    showLoading(false);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function convertExcel(workbook) {
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

            const results = [];
            let currentFlight = null;
            let currentType = null;

            rows.forEach((row, index) => {
                // 忽略表頭和空行
                if (index < 4 || !row[0]) return;

                // 識別新航班
                if (/^\d{3}/.test(row[0])) {
                    const flightInfo = row[0].split(/\s+/);
                    currentFlight = flightInfo[0];
                    currentType = flightInfo[2] || 'N/A';
                    return;
                }

                // 解析車廂資料
                const sectionMap = {'頭車(F)': '頭車', '中車(M)': '中車', '尾車(A)': '尾車'};
                const categories = ['長車', '短車', '炀炉', '手挽'];

                Object.keys(sectionMap).forEach(sectionKey => {
                    const section = sectionMap[sectionKey];
                    const baseIndex = section === '頭車' ? 3 : section === '中車' ? 9 : 15;

                    categories.forEach((category, catIndex) => {
                        const details = {
                            kitchen: parseInt(row[baseIndex + catIndex * 6] || 0,
                            bar: parseInt(row[baseIndex + catIndex * 6 + 1] || 0,
                            elderly: parseInt(row[baseIndex + catIndex * 6 + 2] || 0,
                            water: parseInt(row[baseIndex + catIndex * 6 + 3] || 0,
                            total: parseInt(row[baseIndex + catIndex * 6 + 4] || 0)
                        };

                        if (details.total > 0) {
                            results.push([
                                currentFlight,
                                currentType,
                                section,
                                category,
                                details
                            ]);
                        }
                    });
                });
            });

            return results;
        }

        function downloadData() {
            const jsContent = `let flightDataArray = ${JSON.stringify(convertedData, null, 2)};\n`;
            const blob = new Blob([jsContent], {type: 'application/javascript'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'converted_data.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showLoading(show) {
            document.querySelector('.loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>