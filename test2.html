<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>粵語語音 AI 聊天機械人 (角色扮演)</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; background-color: #f0f0f0; }
        #chatbox { width: 100%; max-width: 600px; height: 400px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; background-color: white; margin-bottom: 20px; }
        .message { margin: 10px 0; padding: 8px; border-radius: 5px; }
        .user { background-color: #007bff; color: white; text-align: right; }
        .bot { background-color: #28a745; color: white; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
        select { padding: 10px; font-size: 16px; margin: 10px; }
    </style>
</head>
<body>
    <h1>粵語語音 AI 聊天機械人 (角色扮演)</h1>
    <label for="roleSelect">選擇角色：</label>
    <select id="roleSelect" onchange="updateRole()">
        <option value="friend">朋友</option>
        <option value="teacher">老師</option>
        <option value="doctor">醫生</option>
        <option value="comedian">搞笑藝人</option>
    </select>
    <div id="chatbox"></div>
    <button onclick="startRecognition()">開始語音輸入</button>
    <button onclick="playLastResponse()">播放上一次回應</button>

    <script>
        const chatbox = document.getElementById('chatbox');
        const roleSelect = document.getElementById('roleSelect');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        const synth = window.speechSynthesis;
        let lastResponse = ''; // 儲存上一次回應

        // 設置語音識別為粵語
        recognition.lang = 'zh-HK';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        // DeepSeek API 配置
        const DEEPSEEK_API_KEY = 'sk-1e817d6ead4f4f1a81191dd60d6a5377'; // 請替換為你的 API Key
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';

        // 角色扮演的系統提示
        const rolePrompts = {
            friend: '你係我嘅好朋友，用輕鬆同親切嘅粵語同我傾計，仲要多啲關心我嘅感受。',
            teacher: '你係我嘅老師，用有耐心同專業嘅粵語教我，解釋要清楚，態度要溫和。',
            doctor: '你係我嘅醫生，用專業但易明嘅粵語同我講解健康問題，仲要多啲安慰我。',
            comedian: '你係一個搞笑藝人，用幽默同誇張嘅粵語同我傾計，目標係要我笑到拆牆！'
        };

        // 初始化對話歷史
        let conversationHistory = [
            { role: 'system', content: rolePrompts[roleSelect.value] }
        ];

        // 更新角色時重設系統提示
        function updateRole() {
            conversationHistory = [
                { role: 'system', content: rolePrompts[roleSelect.value] }
            ];
            addMessage(`已切換角色為：${roleSelect.options[roleSelect.selectedIndex].text}`, 'bot');
        }

        // 開始語音輸入
        function startRecognition() {
            recognition.start();
            addMessage('請講話...', 'bot');
        }

        // 處理語音識別結果並調用 DeepSeek API
        recognition.onresult = async function(event) {
            const userSpeech = event.results[0][0].transcript;
            addMessage(userSpeech, 'user');
            conversationHistory.push({ role: 'user', content: userSpeech });

            const botResponse = await getDeepSeekResponse();
            addMessage(botResponse, 'bot');
            lastResponse = botResponse;
            speak(botResponse);
            conversationHistory.push({ role: 'assistant', content: botResponse });
        };

        recognition.onerror = function(event) {
            addMessage('語音識別出錯，請再試一次', 'bot');
        };

        // 調用 DeepSeek API
        async function getDeepSeekResponse() {
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: conversationHistory,
                        stream: false,
                        max_tokens: 500
                    })
                });
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('DeepSeek API 錯誤:', error);
                return '唔好意思，出現咗啲問題，請再試一次。';
            }
        }

        // 添加訊息到聊天框
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            messageDiv.textContent = text;
            chatbox.appendChild(messageDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // 語音合成
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-HK';
            utterance.onstart = () => console.log('開始播放語音');
            utterance.onerror = (event) => {
                console.error('語音播放錯誤:', event);
                addMessage('播放語音失敗，請檢查設備靜音設置或點擊「播放上一次回應」', 'bot');
            };
            synth.speak(utterance);
        }

        // 手動播放上一次回應
        function playLastResponse() {
            if (lastResponse) {
                speak(lastResponse);
            } else {
                addMessage('未有回應可播放', 'bot');
            }
        }
    </script>
</body>
</html>
