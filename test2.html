<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>區域文字識別工具</title>
    <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>
    <style>
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .preview-area {
            position: relative;
            border: 2px dashed #ccc;
            margin: 20px 0;
        }
        #imagePreview {
            max-width: 100%;
            display: none;
        }
        #selectionBox {
            position: absolute;
            border: 2px solid #ff0000;
            background: rgba(255,0,0,0.1);
            display: none;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>區域數字英文識別工具</h1>
        
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="clearSelection()">清除選區</button>
        
        <div class="preview-area">
            <img id="imagePreview" src="#" alt="預覽圖片">
            <div id="selectionBox"></div>
        </div>
        
        <div id="result">識別結果將顯示在此處</div>
    </div>

<script>
let isDrawing = false;
let startX, startY;
const imagePreview = document.getElementById('imagePreview');
const selectionBox = document.getElementById('selectionBox');
const resultDiv = document.getElementById('result');

// 初始化區域選取功能
imagePreview.addEventListener('mousedown', startSelection);
imagePreview.addEventListener('mousemove', drawSelection);
imagePreview.addEventListener('mouseup', endSelection);

// 文件上傳處理
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
            resetSelection();
        }
        reader.readAsDataURL(file);
    }
});

// 核心OCR處理函數（限定數字英文）
async function processSelectedArea(x, y, width, height) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // 設定選取區域尺寸
    canvas.width = width;
    canvas.height = height;
    
    // 繪製選取區域到Canvas
    ctx.drawImage(
        imagePreview,
        x, y, width, height, // 原始圖片選取區域
        0, 0, width, height  // Canvas繪製區域
    );

    // 影像預處理（提升對比度）
    const imageData = ctx.getImageData(0, 0, width, height);
    const data = imageData.data;
    for(let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
        const threshold = avg > 128 ? 255 : 0;
        data[i] = data[i+1] = data[i+2] = threshold;
    }
    ctx.putImageData(imageData, 0, 0);

    // Tesseract設定
    const worker = await Tesseract.createWorker();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    
    // 嚴格限定數字英文
    await worker.setParameters({
        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz',
        tessedit_pageseg_mode: '7',  // 單行模式
        tessedit_ocr_engine_mode: '3' // LSTM引擎
    });

    const { data: { text } } = await worker.recognize(canvas);
    resultDiv.innerHTML = text.replace(/[^\w]/g, ' '); // 過濾特殊符號
    await worker.terminate();
}

// 區域選取事件處理
function startSelection(e) {
    isDrawing = true;
    const rect = imagePreview.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    selectionBox.style.display = 'block';
}

function drawSelection(e) {
    if (!isDrawing) return;
    const rect = imagePreview.getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;
    
    selectionBox.style.left = Math.min(startX, currentX) + 'px';
    selectionBox.style.top = Math.min(startY, currentY) + 'px';
    selectionBox.style.width = Math.abs(currentX - startX) + 'px';
    selectionBox.style.height = Math.abs(currentY - startY) + 'px';
}

function endSelection(e) {
    isDrawing = false;
    const rect = imagePreview.getBoundingClientRect();
    const endX = e.clientX - rect.left;
    const endY = e.clientY - rect.top;
    
    const x = Math.min(startX, endX) * (imagePreview.naturalWidth / imagePreview.width);
    const y = Math.min(startY, endY) * (imagePreview.naturalHeight / imagePreview.height);
    const width = Math.abs(endX - startX) * (imagePreview.naturalWidth / imagePreview.width);
    const height = Math.abs(endY - startY) * (imagePreview.naturalHeight / imagePreview.height);
    
    processSelectedArea(x, y, width, height);
}

function clearSelection() {
    selectionBox.style.display = 'none';
    resultDiv.innerHTML = '已清除選區';
}

function resetSelection() {
    clearSelection();
    selectionBox.style.width = '0';
    selectionBox.style.height = '0';
}
</script>
</body>
</html>
